<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin - Control de Seguridad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f1724; color:#e6eef8; padding:1rem; }
    .card { border-radius:10px; }
    .small-token { font-family: monospace; }
    .qr-img { max-width:160px; border-radius:6px; background:#fff; padding:6px; }
    .muted { color:#9fb0c8; }
    .role-tabs .btn { min-width:90px; }
    a { color: #9fd1ff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4>Admin — Usuarios</h4>
        <div>
          <a href="index.html" class="btn btn-sm btn-outline-light">Ir al Totem</a>
        </div>
      </div>

      <form id="createForm" class="row g-2">
        <div class="col-md-3">
          <input id="inputId" class="form-control" placeholder="ID (opcional para crear)" />
        </div>
        <div class="col-md-3">
          <input id="inputName" class="form-control" placeholder="Nombre" required />
        </div>
        <div class="col-md-2">
          <select id="inputRole" class="form-select">
            <option value="estudiante">Estudiante</option>
            <option value="docente">Docente</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary">Crear / Actualizar</button>
        </div>
        <div class="col-md-2 text-end">
          <button id="refreshBtn" type="button" class="btn btn-outline-light">Actualizar lista</button>
        </div>
      </form>

      <div id="createResult" class="mt-3"></div>
      <div class="d-flex justify-content-end text-muted" style="font-size:0.9rem;">
        Docentes: <span id="teacherCount" style="margin:0 8px;">0</span> |
        Admins: <span id="adminCount" style="margin-left:8px;">0</span>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5>Usuarios registrados</h5>
        <div class="role-tabs">
          <button class="btn btn-sm btn-outline-light" data-role="">Todos</button>
          <button class="btn btn-sm btn-outline-light" data-role="estudiante">Estudiantes</button>
          <button class="btn btn-sm btn-outline-light" data-role="docente">Docentes</button>
          <button class="btn btn-sm btn-outline-light" data-role="admin">Admins</button>
        </div>
      </div>

      <div class="mb-2">
        Filtrar por rol:
        <select id="filterRole" class="form-select form-select-sm" style="width:180px; display:inline-block; margin-left:8px;">
          <option value="">Todos</option>
          <option value="estudiante">Estudiante</option>
          <option value="docente">Docente</option>
          <option value="admin">Admin</option>
        </select>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-borderless text-white">
          <thead class="muted">
            <tr>
              <th>ID</th><th>Nombre</th><th>Rol</th><th>Token</th><th>QR</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="usersBody">
            <tr><td colspan="6" class="muted">Cargando...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
  /* ---------- CONFIG (cambia solo estas dos constantes según tu entorno) ---------- */
  const BACKEND_URL = "http://localhost:3000";            // cambia si tu backend está en otro host
  const ADMIN_SECRET = "mi_secreto_super_seguro";            // 
  /* -------------------------------------------------------------------------------- */

  // UI elements
  const createForm = document.getElementById('createForm');
  const statusEl = document.getElementById('createResult') || document.createElement('div');
  const usersBody = document.getElementById('usersBody');
  const filterRole = document.getElementById('filterRole');
  const refreshBtn = document.getElementById('refreshBtn');

  let currentFilter = "";

  // Helpers
  function showMessage(text, level='info', timeout=3500) {
    statusEl.innerHTML = `<div class="alert alert-${level} p-2">${text}</div>`;
    setTimeout(()=> { if (statusEl.innerHTML.includes(text)) statusEl.innerHTML = ''; }, timeout);
  }

  function hideToken(t){ if(!t) return ''; return t.length>8? t.substring(0,4)+'…'+t.slice(-4):t; }

  // fetch wrapper with admin-secret header
  async function apiFetch(path, opts = {}) {
    opts.headers = opts.headers || {};
    opts.headers['x-admin-secret'] = ADMIN_SECRET;
    opts.headers['Accept'] = 'application/json';
    if (opts.body && typeof opts.body !== 'string') {
      opts.body = JSON.stringify(opts.body);
      opts.headers['Content-Type'] = 'application/json';
    }
    const res = await fetch(`${BACKEND_URL}${path}`, opts);
    const j = await res.json().catch(()=>({ ok:false, error:'invalid json' }));
    if (!res.ok && j && (j.error === 'unauthorized' || j.error === 'unauthenticated')) {
      return { ok:false, error: 'unauthorized' };
    }
    return j;
  }

  // Create or update any role
  async function createOrUpdateUser(id, name, role) {
    if (!name) return { ok:false, error:'name required' };
    return await apiFetch('/users', { method: 'POST', body: { id: id || undefined, name, role }});
  }

  // Fetch users (role optional)
  async function fetchUsers(role="") {
    try {
      const qs = role ? `?role=${encodeURIComponent(role)}` : '';
      const j = await apiFetch(`/users${qs}`, { method: 'GET' });
      if (!j.ok) {
        usersBody.innerHTML = `<tr><td colspan="6" class="muted">Error al cargar usuarios: ${j.error || 'server'}</td></tr>`;
        return [];
      }
      return j.data || [];
    } catch (e) {
      usersBody.innerHTML = `<tr><td colspan="6" class="muted">Error de red</td></tr>`;
      return [];
    }
  }

  // Render table
  async function renderUsersTable(roleFilter="") {
    usersBody.innerHTML = '<tr><td colspan="6" class="muted">Cargando...</td></tr>';
    const rows = await fetchUsers(roleFilter);
    if (!rows.length) {
      usersBody.innerHTML = `<tr><td colspan="6" class="muted">Sin usuarios</td></tr>`;
      return;
    }
    usersBody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><a href="user.html?id=${encodeURIComponent(r.id)}" target="_blank">${r.id}</a></td>
        <td>${r.name || ''}</td>
        <td>${r.role || ''}</td>
        <td class="small-token">${hideToken(r.token)}</td>
        <td>${r.qrDataUrl ? `<img src="${r.qrDataUrl}" style="max-width:120px;">` : ''}</td>
        <td>
          <button class="btn btn-sm btn-outline-light edit-btn" data-id="${r.id}" data-name="${r.name || ''}" data-role="${r.role || ''}">Editar</button>
          <button class="btn btn-sm btn-outline-light regen-btn" data-id="${r.id}">Regenerar</button>
          <button class="btn btn-sm btn-danger del-btn" data-id="${r.id}">Eliminar</button>
        </td>
      `;
      usersBody.appendChild(tr);
    });

    // listeners
    document.querySelectorAll('.edit-btn').forEach(b => {
      b.onclick = () => {
        document.getElementById('inputId').value = b.dataset.id || '';
        document.getElementById('inputName').value = b.dataset.name || '';
        document.getElementById('inputRole').value = b.dataset.role || 'estudiante';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      };
    });

    document.querySelectorAll('.regen-btn').forEach(b => {
      b.onclick = async () => {
        const id = b.dataset.id;
        if (!confirm(`Regenerar token para ${id}?`)) return;
        b.disabled = true;
        const res = await apiFetch('/users', { method: 'POST', body: { id, regenerate: true }});
        if (res.ok) {
          showMessage(`Token regenerado para ${id}`, 'success');
          await refreshAll();
        } else {
          showMessage(`Error: ${res.error || 'server'}`, 'danger');
        }
        b.disabled = false;
      };
    });

    document.querySelectorAll('.del-btn').forEach(b => {
      b.onclick = async () => {
        const id = b.dataset.id;
        if (!confirm(`Eliminar ${id}? Esto borrará student y token.`)) return;
        b.disabled = true;
        const res = await apiFetch(`/users/${encodeURIComponent(id)}`, { method: 'DELETE' });
        if (res.ok) {
          showMessage(`Usuario ${id} eliminado`, 'success');
          await refreshAll();
        } else {
          showMessage(`Error: ${res.error || 'server'}`, 'danger');
        }
        b.disabled = false;
      };
    });
  }

  // Counts for docentes/admins
  async function loadCounts() {
    try {
      const t = await apiFetch('/users?role=docente', { method: 'GET' });
      const a = await apiFetch('/users?role=admin', { method: 'GET' });
      document.getElementById('teacherCount').innerText = (t && t.count) ? t.count : 0;
      document.getElementById('adminCount').innerText = (a && a.count) ? a.count : 0;
    } catch (e) { /* ignore */ }
  }

  async function refreshAll() {
    await renderUsersTable(currentFilter);
    await loadCounts();
  }

  // form submit
  createForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const id = document.getElementById('inputId').value.trim();
    const name = document.getElementById('inputName').value.trim();
    const role = document.getElementById('inputRole').value || 'estudiante';
    if (!name) { showMessage('Nombre requerido', 'warning'); return; }
    showMessage('Creando/Actualizando...', 'info', 2000);
    const res = await createOrUpdateUser(id, name, role);
    if (res.ok) {
      showMessage(`Usuario ${res.id} creado/actualizado (${role})`, 'success');
      document.getElementById('inputId').value = '';
      document.getElementById('inputName').value = '';
      await refreshAll();
    } else {
      if (res.error === 'unauthorized') showMessage('Error: unauthorized. Verifica ADMIN_SECRET', 'danger', 7000);
      else showMessage(`Error: ${res.error || 'server'}`, 'danger', 5000);
    }
  });

  // filter role
  filterRole?.addEventListener('change', async (e) => {
    currentFilter = e.target.value || "";
    await renderUsersTable(currentFilter);
  });

  // role tab buttons
  document.querySelectorAll('.role-tabs button').forEach(btn=>{
    btn.addEventListener('click', async (ev)=>{
      const r = btn.dataset.role || '';
      filterRole.value = r;
      currentFilter = r;
      await renderUsersTable(currentFilter);
    });
  });

  // refresh button
  refreshBtn?.addEventListener('click', () => refreshAll());

  // initial load
  window.addEventListener('load', async () => {
    await refreshAll();
  });

  // expose helper for form use
  async function createOrUpdateUser(id, name, role) {
    return await apiFetch('/users', { method: 'POST', body: { id: id || undefined, name, role }});
  }
  </script>
</body>
</html>

