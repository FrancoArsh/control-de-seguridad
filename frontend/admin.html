<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Control de Seguridad (Usuarios & Shifts & Historial)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f1724; color:#e6eef8; padding:1rem; }
    .card { border-radius:10px; }
    .muted { color:#9fb0c8; }
    .hidden { display:none !important; }
    .nav-btn { min-width:120px; }
    .mono { font-family: monospace; }
    .small-muted { color:#9fb0c8; font-size:.9rem; }
    .list-group-item { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.03); }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header + internal nav -->
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h3>Admin — Panel</h3>
      <div>
        <button id="btnNavUsers" class="btn btn-sm btn-outline-light nav-btn">Usuarios</button>
        <button id="btnNavShifts" class="btn btn-sm btn-outline-light nav-btn">Turnos</button>
        <button id="btnNavHistory" class="btn btn-sm btn-outline-light nav-btn">Historial</button>
        <a href="index.html" class="btn btn-sm btn-outline-light">Ir al Totem</a>
      </div>
    </div>

    <div id="alertArea"></div>

    <!-- SECTION: USERS (Admin) -->
    <section id="sectionUsers" class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">Usuarios (Estudiantes / Docentes / Admins)</h5>
        <div class="small-muted">Crea, edita, regenera tokens y elimina usuarios</div>
      </div>

      <form id="createForm" class="row g-2 mb-3">
        <div class="col-md-3"><input id="inputId" class="form-control" placeholder="ID (opcional)"></div>
        <div class="col-md-3"><input id="inputName" class="form-control" placeholder="Nombre" required></div>
        <div class="col-md-2">
          <select id="inputRole" class="form-select">
            <option value="estudiante">Estudiante</option>
            <option value="docente">Docente</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="col-md-2"><button id="createBtn" class="btn btn-primary w-100" type="submit">Crear / Actualizar</button></div>
        <div class="col-md-2"><button id="refreshUsersBtn" type="button" class="btn btn-outline-light w-100">Actualizar</button></div>
      </form>

      <div class="mb-2">
        Filtrar por rol:
        <select id="filterRole" class="form-select form-select-sm" style="width:180px; display:inline-block; margin-left:8px;">
          <option value="">Todos</option>
          <option value="estudiante">Estudiantes</option>
          <option value="docente">Docentes</option>
          <option value="admin">Admins</option>
        </select>
      </div>

      <div class="table-responsive mt-2">
        <table class="table table-sm table-borderless text-white">
          <thead class="muted"><tr><th>ID</th><th>Nombre</th><th>Rol</th><th>Token</th><th>QR</th><th>Acciones</th></tr></thead>
          <tbody id="usersBody"><tr><td colspan="6" class="muted">Cargando...</td></tr></tbody>
        </table>
      </div>
    </section>

    <!-- SECTION: SHIFTS (Admin-Shift) -->
    <section id="sectionShifts" class="card p-3 mb-3 hidden">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="m-0">Turnos — Guardias</h5>
        <div class="small-muted">Inicia / finaliza turnos de guardias y revisa historial por turno</div>
      </div>

      <div class="row g-2 mb-2">
        <div class="col-md-3">
          <select id="guardSelect" class="form-select">
            <option value="">Selecciona guard</option>
          </select>
        </div>
        <div class="col-md-3">
          <button id="btnAdminStartShift" class="btn btn-success w-100">Iniciar turno (admin)</button>
        </div>
        <div class="col-md-3">
          <button id="btnAdminEndShift" class="btn btn-danger w-100">Finalizar turno (admin)</button>
        </div>
        <div class="col-md-3">
          <button id="refreshShiftsBtn" class="btn btn-outline-light w-100">Actualizar lista</button>
        </div>
      </div>

      <div class="d-flex gap-2 mb-2 align-items-center">
        <button id="btnShowActive" class="btn btn-sm btn-primary">Mostrar En turno</button>
        <button id="btnShowAll" class="btn btn-sm btn-outline-light">Mostrar Todos</button>
        <!-- NUEVO: Filtros de fecha -->
        <input type="date" id="filterStartDate" class="form-control form-control-sm w-auto" />
        <input type="date" id="filterEndDate" class="form-control form-control-sm w-auto" />
        <button id="btnFilterDate" class="btn btn-sm btn-success">Filtrar</button>
      </div>

      <div class="row mt-2">
        <div class="col-md-6">
          <h6>En turno</h6>
          <div id="activeList" class="list-group mb-3"></div>
        </div>
        <div class="col-md-6">
          <h6>Todos los shifts recientes</h6>
          <div id="allList" class="list-group mb-3"></div>
        </div>
      </div>
    </section>

    <!-- SECTION: HISTORY (Admin - Access Logs) -->
    <section id="sectionHistory" class="card p-3 mb-3 hidden">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h5 class="m-0">Historial de accesos</h5>
    <div class="small-muted">Registros de estudiantes y guardias</div>
  </div>

  <div class="row g-2 mb-2 align-items-end">
    <div class="col-md-3">
      <input id="filterGuardHistory" class="form-control" placeholder="Filtrar por guard ID (ej: guard-01)">
    </div>
    <div class="col-md-3">
      <input id="filterStartHistory" type="date" class="form-control">
    </div>
    <div class="col-md-3">
      <input id="filterEndHistory" type="date" class="form-control">
    </div>
    <div class="col-md-3">
      <button id="btnFilterHistory" class="btn btn-primary w-100">Aplicar filtros</button>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table table-sm table-borderless text-white align-middle">
      <thead class="muted">
        <tr>
          <th>Fecha/Hora</th>
          <th>Estudiante</th>
          <th>Guardia</th>
          <th>Shift ID</th>
          <th>Resultado</th>
          <th>Motivo</th>
        </tr>
      </thead>
      <tbody id="historyBody"><tr><td colspan="6" class="muted">Cargando...</td></tr></tbody>
    </table>
  </div>
</section>

  </div>

<script>
/* ====== CONFIG: ajusta según tu entorno ====== */
const BACKEND_URL = "http://localhost:3000";   // cambia si corresponde
const ADMIN_SECRET = "mi_secreto_super_seguro"; // reemplaza por tu ADMIN_SECRET local (NO subir a repo)
/* ============================================ */

function toast(msg, level='info', timeout=3500) {
  const a = document.getElementById('alertArea');
  const el = document.createElement('div');
  el.innerHTML = `<div class="alert alert-${level} p-2">${msg}</div>`;
  a.appendChild(el);
  setTimeout(()=> { try { a.removeChild(el); } catch(e){} }, timeout);
}

/* ---- Utils para llamadas al backend (admin) ---- */
async function adminFetch(path, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers['x-admin-secret'] = ADMIN_SECRET;
  opts.headers['Accept'] = 'application/json';
  if (opts.body && typeof opts.body !== 'string') {
    opts.body = JSON.stringify(opts.body);
    opts.headers['Content-Type'] = 'application/json';
  }
  const res = await fetch(`${BACKEND_URL}${path}`, opts);
  const json = await res.json().catch(()=>({ ok:false, error:'invalid json' }));
  return { ok: res.ok, status: res.status, body: json };
}

/* ===================== USERS ===================== */
async function fetchUsers(role="") {
  const qs = role ? `?role=${encodeURIComponent(role)}` : '';
  const r = await adminFetch(`/users${qs}`, { method: 'GET' });
  if (!r.ok) return { ok:false, error: r.body.error || 'server' };
  return { ok:true, data: r.body.data || [] };
}

async function renderUsersTable(roleFilter="") {
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = '<tr><td colspan="6" class="muted">Cargando...</td></tr>';
  const r = await fetchUsers(roleFilter);
  if (!r.ok) { tbody.innerHTML = `<tr><td colspan="6" class="muted">Error: ${r.error}</td></tr>`; return; }
  const rows = r.data;
  if (!rows.length) { tbody.innerHTML = `<tr><td colspan="6" class="muted">Sin usuarios</td></tr>`; return; }
  tbody.innerHTML = '';
  rows.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><a href="user.html?id=${encodeURIComponent(u.id)}" target="_blank">${u.id}</a></td>
      <td>${u.name || ''}</td>
      <td>${u.role || ''}</td>
      <td class="mono">${u.token ? u.token.slice(0,6) + '…' : ''}</td>
      <td>${u.token ? `<img src="${u.qrDataUrl||''}" style="max-width:120px">` : ''}</td>
      <td>
        <button class="btn btn-sm btn-outline-light edit-btn" data-id="${u.id}" data-name="${encodeURIComponent(u.name||'')}" data-role="${u.role}">Editar</button>
        <button class="btn btn-sm btn-outline-light regen-btn" data-id="${u.id}">Regenerar</button>
        <button class="btn btn-sm btn-danger del-btn" data-id="${u.id}">Eliminar</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // listeners
  document.querySelectorAll('.edit-btn').forEach(b => {
    b.onclick = () => {
      document.getElementById('inputId').value = b.dataset.id || '';
      document.getElementById('inputName').value = decodeURIComponent(b.dataset.name || '');
      document.getElementById('inputRole').value = b.dataset.role || 'estudiante';
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };
  });
  document.querySelectorAll('.regen-btn').forEach(b => {
    b.onclick = async () => {
      const id = b.dataset.id;
      if (!confirm(`Regenerar token para ${id}?`)) return;
      b.disabled = true;
      const r = await adminFetch('/users', { method:'POST', body: { id, regenerate: true }});
      if (!r.ok) toast('Error regenerando: ' + (r.body.error||'server'), 'danger'); else { toast('Token regenerado', 'success'); await renderUsersTable(document.getElementById('filterRole').value); }
      b.disabled = false;
    };
  });
  document.querySelectorAll('.del-btn').forEach(b => {
    b.onclick = async () => {
      const id = b.dataset.id;
      if (!confirm(`Eliminar usuario ${id}?`)) return;
      b.disabled = true;
      const r = await adminFetch(`/users/${encodeURIComponent(id)}`, { method:'DELETE' });
      if (!r.ok) toast('Error eliminando: '+(r.body.error||'server'),'danger'); else { toast('Usuario eliminado','success'); await renderUsersTable(document.getElementById('filterRole').value); }
      b.disabled = false;
    };
  });
}

/* Create/Update form */
document.getElementById('createForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();
  const id = document.getElementById('inputId').value.trim();
  const name = document.getElementById('inputName').value.trim();
  const role = document.getElementById('inputRole').value;
  if (!name) { toast('Nombre requerido','warning'); return; }
  const r = await adminFetch('/users', { method: 'POST', body: { id: id || undefined, name, role }});
  if (!r.ok) toast('Error: ' + (r.body.error||'server'), 'danger'); else { toast(`Usuario ${r.body.id} creado/actualizado`,'success'); document.getElementById('inputId').value=''; document.getElementById('inputName').value=''; await renderUsersTable(document.getElementById('filterRole').value); }
});

document.getElementById('filterRole').addEventListener('change', ()=> renderUsersTable(document.getElementById('filterRole').value));
document.getElementById('refreshUsersBtn').addEventListener('click', ()=> renderUsersTable(document.getElementById('filterRole').value));

/* ===================== SHIFTS ===================== */
async function fetchGuardsList() {
  const r = await adminFetch('/guards', { method: 'GET' });
  if (!r.ok) return [];
  return r.body.data || [];
}

async function loadGuardSelect() {
  const g = await fetchGuardsList();
  const sel = document.getElementById('guardSelect');
  sel.innerHTML = '<option value="">Selecciona guard</option>';
  g.forEach(x => sel.innerHTML += `<option value="${x.id}">${x.id} ${x.name?'- '+x.name:''}</option>`);
}

async function fetchShifts(activeOnly=false, startDate=null, endDate=null) {
  let qs = activeOnly ? '?active=true' : '';
  const r = await adminFetch(`/guardShifts${qs}`, { method:'GET' });
  if (!r.ok) return [];
  let data = r.body.data || [];
  // date filtering optional (client-side)
  if (startDate) {
    const s = new Date(startDate).getTime();
    data = data.filter(d => (d.startTimestamp || 0) >= s);
  }
  if (endDate) {
    const e = new Date(endDate).getTime() + 86400000;
    data = data.filter(d => (d.startTimestamp || 0) <= e);
  }
  return data;
}

function formatTime(ts) { return ts ? new Date(ts).toLocaleString() : '-'; }

function renderShiftItemHtml(s) {
  const start = formatTime(s.startTimestamp);
  const end = s.endTimestamp ? formatTime(s.endTimestamp) : null;
  const status = (!s.endTimestamp && s.active !== false) ? 'En turno' : 'Fuera de turno';
  const badge = status === 'En turno' ? 'badge bg-success' : 'badge bg-secondary';
  return `
    <div class="list-group-item d-flex justify-content-between align-items-start">
      <div>
        <div><strong>${s.guardId}</strong> ${s.guardName ? '- ' + s.guardName : ''}</div>
        <div class="small text-muted">Inicio: ${start} ${end ? ' • Fin: ' + end : ''}</div>
      </div>
      <div class="text-end">
        <div><span class="${badge}">${status}</span></div>
        <div class="mt-2">
          ${status === 'En turno' ? `<button class="btn btn-sm btn-outline-light end-shift" data-id="${s.id}">Finalizar</button>` : ''}
          <button class="btn btn-sm btn-outline-light view-shift" data-id="${s.id}">Ver</button>
        </div>
      </div>
    </div>
  `;
}

async function refreshShiftsView() {
  const startDate = document.getElementById('filterStartDate').value || null;
  const endDate = document.getElementById('filterEndDate').value || null;

  const active = await fetchShifts(true, startDate, endDate);
  document.getElementById('activeList').innerHTML = active.length ? active.map(renderShiftItemHtml).join('') : '<div class="muted p-2">No hay guardias en turno</div>';
  const all = await fetchShifts(false, startDate, endDate);
  document.getElementById('allList').innerHTML = all.length ? all.map(renderShiftItemHtml).join('') : '<div class="muted p-2">Sin registros</div>';

  // attach finalizer handlers
  document.querySelectorAll('.end-shift').forEach(b => {
    b.onclick = async () => {
      const id = b.dataset.id;
      if (!confirm('Finalizar shift '+id+' ?')) return;
      b.disabled = true;
      const r = await adminFetch('/admin/guard/shift/end', { method:'POST', body: { shiftId: id }});
      if (!r.ok) toast('Error finalizando: ' + (r.body.error||'server'), 'danger'); else { toast('Shift finalizado','success'); await refreshShiftsView(); }
      b.disabled = false;
    };
  });

  document.querySelectorAll('.view-shift').forEach(b => {
    b.onclick = async () => {
      const id = b.dataset.id;
      window.open(`shift_history.html?shiftId=${encodeURIComponent(id)}`, '_blank');
    };
  });
}

/* Admin start/end shift for selected guard (buttons) */
document.getElementById('btnAdminStartShift').addEventListener('click', async () => {
  const guardId = document.getElementById('guardSelect').value;
  if (!guardId) { toast('Selecciona un guard','warning'); return; }
  const r = await adminFetch('/admin/guard/shift/start', { method:'POST', body: { guardId }});
  if (!r.ok) toast('Error iniciando shift: ' + (r.body.error||'server'), 'danger'); else { toast('Shift iniciado: ' + r.body.shiftId, 'success'); await refreshShiftsView(); }
});

document.getElementById('btnAdminEndShift').addEventListener('click', async () => {
  const guardId = document.getElementById('guardSelect').value;
  if (!guardId) { toast('Selecciona un guard','warning'); return; }
  const r = await adminFetch('/admin/guard/shift/end', { method:'POST', body: { guardId }});
  if (!r.ok) toast('Error finalizando shift: ' + (r.body.error||'server'), 'danger'); else { toast('Shift finalizado','success'); await refreshShiftsView(); }
});

document.getElementById('refreshShiftsBtn').addEventListener('click', () => refreshShiftsView());

document.getElementById('btnShowActive').addEventListener('click', () => {
  document.getElementById('allList').style.display = 'none';
  document.getElementById('activeList').style.display = 'block';
});
document.getElementById('btnShowAll').addEventListener('click', () => {
  document.getElementById('allList').style.display = 'block';
  document.getElementById('activeList').style.display = 'block';
});
document.getElementById('btnFilterDate').addEventListener('click', () => refreshShiftsView());

/* ===================== HISTORY ===================== */
async function loadHistoryTable() {
  const tbody = document.getElementById('historyBody');
  const guardId = document.getElementById('filterGuardHistory').value.trim();
  const start = document.getElementById('filterStartHistory').value;
  const end = document.getElementById('filterEndHistory').value;
  tbody.innerHTML = '<tr><td colspan="6" class="muted">Cargando...</td></tr>';

  try {
    const resp = await fetch(`${BACKEND_URL}/history?limit=500`);
    const js = await resp.json();
    if (!js.ok) {
      tbody.innerHTML = `<tr><td colspan="6" class="muted">Error: ${js.error}</td></tr>`;
      return;
    }

    let rows = js.data || [];

    // filtrar por guardia
    if (guardId)
      rows = rows.filter(r =>
        (r.guardId && String(r.guardId).includes(guardId)) || r.guardId === guardId
      );

    // filtrar por fecha (cliente)
    if (start) {
      const s = new Date(start).getTime();
      rows = rows.filter(r => Number(r.timestamp || 0) >= s);
    }
    if (end) {
      const e = new Date(end).getTime() + 86400000;
      rows = rows.filter(r => Number(r.timestamp || 0) <= e);
    }

    if (!rows.length) {
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Sin resultados</td></tr>';
      return;
    }

    // render
    tbody.innerHTML = rows.map(r => {
      const when = r.timestamp ? new Date(r.timestamp).toLocaleString() : '-';
      const student = r.studentName || r.id || '-';
      const guard = r.guardName || r.guardId || '-';
      const shift = r.shiftId || (r.guardOverrideId ? r.guardOverrideId : '-') ;
      const motivo = r.reason || '-';

      let resultHtml = '-';
      if (r.authorized === true)
        resultHtml = `<span class="badge bg-success">Autorizado</span>`;
      else if (r.authorized === false)
        resultHtml = `<span class="badge bg-danger">Rechazado</span>`;
      else
        resultHtml = `<span class="badge bg-secondary">${r.reason ? 'Manual' : 'Desconocido'}</span>`;

      return `<tr>
        <td>${when}</td>
        <td>${student}</td>
        <td>${guard}</td>
        <td class="mono">${shift}</td>
        <td>${resultHtml}</td>
        <td>${motivo}</td>
      </tr>`;
    }).join('');

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="6" class="muted">Error de red: ${e.message || e}</td></tr>`;
  }
}

document.getElementById('btnFilterHistory').addEventListener('click', loadHistoryTable);

/* ========== Internal navigation: show/hide sections ========== */
const sectionUsers = document.getElementById('sectionUsers');
const sectionShifts = document.getElementById('sectionShifts');
const sectionHistory = document.getElementById('sectionHistory');
const btnNavUsers = document.getElementById('btnNavUsers');
const btnNavShifts = document.getElementById('btnNavShifts');
const btnNavHistory = document.getElementById('btnNavHistory');

function clearNavStyles() {
  [btnNavUsers, btnNavShifts, btnNavHistory].forEach(b => {
    b.classList.remove('btn-primary');
    b.classList.add('btn-outline-light');
  });
}

function showSection(name) {
  sectionUsers.classList.add('hidden');
  sectionShifts.classList.add('hidden');
  sectionHistory.classList.add('hidden');
  clearNavStyles();

  if (name === 'shifts') {
    sectionShifts.classList.remove('hidden');
    btnNavShifts.classList.add('btn-primary');
    loadGuardSelect(); refreshShiftsView();
    history.replaceState(null, '', '#shifts');
  } else if (name === 'history') {
    sectionHistory.classList.remove('hidden');
    btnNavHistory.classList.add('btn-primary');
    loadHistoryTable();
    history.replaceState(null, '', '#history');
  } else {
    sectionUsers.classList.remove('hidden');
    btnNavUsers.classList.add('btn-primary');
    renderUsersTable(document.getElementById('filterRole').value);
    history.replaceState(null, '', '#users');
  }
}

btnNavUsers.addEventListener('click', ()=> showSection('users'));
btnNavShifts.addEventListener('click', ()=> showSection('shifts'));
btnNavHistory.addEventListener('click', ()=> showSection('history'));

/* On load: decide section by hash, load users by default */
window.addEventListener('load', async () => {
  // minimal initial state
  const h = location.hash.replace('#','');
  if (h === 'shifts') showSection('shifts');
  else if (h === 'history') showSection('history');
  else showSection('users');
});

/* Quick initial loaders */
(async function init() {
  await renderUsersTable('');
  await loadGuardSelect();
  await refreshShiftsView();
})();
</script>
</body>
</html>
