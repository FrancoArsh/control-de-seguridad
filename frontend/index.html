<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Esc√°ner QR - Demo Control de Seguridad</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    body { padding: 1.25rem; background: #0b1220; color: #e6eef8; }
    .card { border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); }
    #reader { width: 360px; max-width:100%; margin: auto; }
    #status { font-weight: 700; margin-top: 1rem; }
    .led {
      width: 24px; height: 24px; border-radius: 50%;
      display:inline-block; margin-right: 8px; vertical-align: middle;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
      background: #444;
    }
    .led.green { background: #2ecc71; box-shadow: 0 0 16px rgba(46,204,113,0.8); }
    .led.red { background: #e74c3c; box-shadow: 0 0 16px rgba(231,76,60,0.8); }
    .led.off { background: #444; box-shadow: none; }
    #manual { margin-top: 1rem; }
    .small-muted { color: #9fb0c8; font-size: .9rem; }
    .busy { opacity: 0.6; pointer-events: none; }
  </style>
</head>

<body>
  <div class="container">
    <div class="card p-3 mt-4">
      <h4>Esc√°ner QR ‚Äî Demo Control de Seguridad</h4>
      <p class="small-muted">Escanea un c√≥digo QR o ingresa un token manualmente. El sistema verificar√° la autorizaci√≥n en Firebase.</p>

      <div id="reader" class="my-2"></div>

      <div id="status" class="alert alert-secondary">Esperando escaneo...</div>

      <div class="d-flex align-items-center my-2">
        <span id="led" class="led off" title="Estado del acceso"></span>
        <div>
          <div id="statusText">Estado: esperando</div>
          <div class="small-muted" id="subText">sin actividad</div>
        </div>
      </div>

      <div id="manual" class="mt-3">
        <label for="manualToken" class="form-label small-muted">Entrada manual (token o JSON):</label>
        <div class="input-group">
          <input id="manualToken" class="form-control" placeholder='Ej: {"id":"est-001","token":"abc123"} o solo el token' />
          <button id="manualBtn" class="btn btn-primary">Enviar</button>
        </div>
      </div>

      <hr />
      <div class="small-muted">Notas: Si el servidor est√° en otra m√°quina, actualiza la variable <b>BACKEND_URL</b> en el script.</div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("‚úÖ DOM completamente cargado");

  // === CONFIGURACI√ìN ===
  const BACKEND_URL = "http://localhost:3000"; // Ajusta si usas otro host o puerto
  const SCAN_DEBOUNCE_MS = 1200;
  const RETRY_ATTEMPTS = 3;
  const RETRY_DELAY_MS = 800;

  let lastScan = 0;
  let processing = false;

  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const subText = document.getElementById('subText');
  const ledEl = document.getElementById('led');
  const manualBtn = document.getElementById('manualBtn');
  const manualInput = document.getElementById('manualToken');

  if (!manualBtn) {
    console.error("‚ùå No se encontr√≥ el bot√≥n manualBtn en el DOM");
    return;
  } else {
    console.log("‚úÖ Bot√≥n manualBtn detectado correctamente");
  }

  // === FUNCIONES DE INTERFAZ ===
  function setStatus(kind, main, sub = '') {
    statusEl.className = 'alert';
    switch(kind){
      case 'success': statusEl.classList.add('alert-success'); break;
      case 'error':   statusEl.classList.add('alert-danger');  break;
      case 'warning': statusEl.classList.add('alert-warning'); break;
      default:        statusEl.classList.add('alert-secondary');
    }
    statusEl.innerText = main;
    statusText.innerText = 'Estado: ' + main;
    subText.innerText = sub;
  }

  function setLed(color) {
    ledEl.classList.remove('green','red','off');
    if (color === 'green') ledEl.classList.add('green');
    else if (color === 'red') ledEl.classList.add('red');
    else ledEl.classList.add('off');
  }

  // === L√ìGICA QR Y ENV√çO ===
  function parseQrPayload(decodedText) {
    try {
      const obj = JSON.parse(decodedText);
      if (obj && obj.id && obj.token) return { id: String(obj.id), token: String(obj.token) };
    } catch { /* no es JSON */ }
    return { token: decodedText };
  }

  async function sendToBackend(payload) {
    if (!payload || !payload.token) return { authorized:false, message:'Token vac√≠o' };

    try {
      const resp = await fetch(`${BACKEND_URL}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: payload.id, token: payload.token }),
        cache: 'no-store'
      });
      return await resp.json();
    } catch (err) {
      console.error("Error conectando con backend:", err);
      return { authorized:false, message:'Error de conexi√≥n con backend' };
    }
  }

  async function processScanned(decodedText) {
    console.log("üì¶ processScanned ejecutado con:", decodedText);
    const now = Date.now();
    if (processing || now - lastScan < SCAN_DEBOUNCE_MS) return;
    lastScan = now;
    processing = true;
    document.body.classList.add('busy');
    setStatus('warning','Validando token...','Conectando al servidor');

    const payload = parseQrPayload(decodedText);
    const result = await sendToBackend(payload);

    if (result && result.authorized) {
      setStatus('success','‚úî Acceso autorizado', result.message || 'Autorizado');
      setLed('green');
    } else {
      setStatus('error','‚úñ Acceso denegado', result.message || 'Token incorrecto');
      setLed('red');
    }

    processing = false;
    document.body.classList.remove('busy');
  }

  // === ENTRADA MANUAL ===
  manualBtn.addEventListener('click', async () => {
    console.log("üëâ Bot√≥n manual presionado");
    const raw = manualInput.value.trim();
    if (!raw) return setStatus('warning','Token vac√≠o','Ingresa un token o JSON');
    setStatus('warning','Validando token...','');
    await processScanned(raw);
  });

  // === INICIALIZAR ESC√ÅNER (solo si hay c√°mara) ===
  if (window.Html5Qrcode) {
    Html5Qrcode.getCameras().then(cameras => {
      const camId = cameras.length ? cameras[0].id : null;
      if (camId) {
        const qr = new Html5Qrcode("reader");
        qr.start(camId, { fps:10, qrbox:250 }, text => processScanned(text));
      } else {
        console.warn("‚ö†Ô∏è C√°mara no detectada");
      }
    }).catch(err => console.error("Error iniciando c√°mara:", err));
  }

  // === AUTO RESET ===
  setInterval(() => {
    setLed('off');
    setStatus('info','Esperando escaneo...','');
  }, 7000);
});
</script>

</body>
</html>