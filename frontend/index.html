<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bienvenido - Identifícate</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg: #07101a;
      --card: #0b1724;
      --muted: #94abc0;
      --accent: #2f9cff;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body {
      padding: 1.25rem;
      background: linear-gradient(180deg, #051016 0%, #07101a 100%);
      color: #e6eef8;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height:100vh;
    }
    .card {
      background: linear-gradient(180deg, var(--card), #071421);
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
    }
    h4 { font-weight:700; }
    .small-muted { color: var(--muted); font-size: .95rem; }

    #reader {
      width: 420px;
      max-width: 100%;
      height: 320px;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      background: var(--glass);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    #status { font-weight:700; margin-top:1rem; border-radius:8px; }
    .led {
      width: 20px; height: 20px; border-radius: 50%;
      display:inline-block; margin-right: 10px; vertical-align: middle;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      background: #3b4853;
    }
    .led.green { background: #2ecc71; box-shadow: 0 0 20px rgba(46,204,113,0.35); }
    .led.red { background: #e74c3c; box-shadow: 0 0 20px rgba(231,76,60,0.35); }
    .led.off { background: #3b4853; box-shadow: none; }

    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    @media (max-width:720px) {
      #reader { height: 260px; }
      .controls { flex-direction:column; align-items:stretch; }
    }
  </style>

  <!-- html5-qrcode: try CDN then fallback to local copy -->
  <script>
  (function loadHtml5Qrcode() {
    const cdn = "https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js";
    function inject(src) {
      return new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.onload = () => res(src);
        s.onerror = (e) => rej(e);
        document.head.appendChild(s);
      });
    }

    inject(cdn)
      .then(src => console.log('[INIT] html5-qrcode loaded from CDN:', src))
      .catch(err => {
        console.warn('[INIT] CDN failed, attempting local fallback. Error:', err);
        // local fallback path (serve this file from your frontend folder)
        return inject('/js/html5-qrcode.min.js')
          .then(src => console.log('[INIT] html5-qrcode loaded locally:', src))
          .catch(err2 => {
            console.error('[INIT] local fallback also failed:', err2);
            // inform user in UI
            const r = document.getElementById('reader') || document.body;
            const msg = document.createElement('div');
            msg.style.color = 'salmon';
            msg.style.padding = '12px';
            msg.innerText = 'Error cargando el escáner (html5-qrcode). Revisa la consola.';
            if (r && r.prepend) r.prepend(msg);
          });
      });
  })();
  </script>

</head>
<body>
  <div class="container">
    <div class="card p-4 mt-4">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h4>Bienvenido — Identifícate</h4>
          <div class="small-muted">Escanea el código QR o revisa tu historial.</div>
        </div>
        <a id="openHistoryBtn" href="history.html" class="btn btn-outline-light">Ver historial</a>
      </div>

      <div id="reader" class="mb-3">
        <div class="small-muted">Cámara inactiva — espera...</div>
      </div>

      <div id="status" class="alert alert-secondary">Esperando escaneo...</div>

      <div class="d-flex align-items-center my-2 controls">
        <span id="led" class="led off"></span>
        <div style="flex:1">
          <div id="statusText" style="font-weight:600">Estado: esperando</div>
          <div id="subText" class="small-muted">sin actividad</div>
        </div>
      </div>

      <hr>
      <div class="small-muted">Si usas otra máquina, actualiza <code>BACKEND_URL</code>.</div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM cargado — index.js init");

  const BACKEND_URL = "https://control-de-seguridad.onrender.com";
  const SCAN_DEBOUNCE_MS = 1200;
  let lastScan = 0;
  let processing = false;

  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const subText = document.getElementById('subText');
  const ledEl = document.getElementById('led');
  const readerEl = document.getElementById('reader');

  function setStatus(kind, main, sub='') {
    statusEl.className = 'alert';
    statusEl.classList.add(
      kind === 'success' ? 'alert-success' :
      kind === 'error'   ? 'alert-danger'  :
      kind === 'warning' ? 'alert-warning' : 'alert-secondary'
    );
    statusEl.innerText = main;
    statusText.innerText = "Estado: " + main;
    subText.innerText = sub;
  }

  function setLed(color) {
    ledEl.classList.remove('green','red','off');
    ledEl.classList.add(color || 'off');
  }

  function parseQrPayload(txt) {
    try {
      const o = JSON.parse(txt);
      if (o.id && o.token) return { id:o.id, token:o.token };
    } catch {}
    return { token: txt };
  }

  async function sendToBackend(payload) {
    try {
      const resp = await fetch(`${BACKEND_URL}/verify`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload),
      });
      return resp.json();
    } catch {
      return { authorized:false, message:"Error de conexión" };
    }
  }

  async function processScanned(decodedText) {
    const now = Date.now();
    if (processing || now - lastScan < SCAN_DEBOUNCE_MS) return;
    processing = true;
    lastScan = now;

    setStatus("warning","Validando...","Conectando al servidor");

    const payload = parseQrPayload(decodedText);
    const res = await sendToBackend(payload);

    if (res.authorized === true || res.authorized === "true") {
      setStatus("success","✔ Acceso autorizado", res.message || "");
      setLed("green");
    } else {
      setStatus("error","✖ Acceso denegado", res.message || "");
      setLed("red");
    }

    processing = false;
  }

  (async () => {
    // elemento donde va el lector
    const readerEl = document.getElementById('reader');

    if (!window.Html5Qrcode) {
      readerEl.innerHTML = "<div class='small-muted'>Escáner no disponible (librería no cargada)</div>";
      return;
    }

    // Helper para mostrar mensajes en UI
    function showReaderMsg(msg, cls = 'small-muted') {
      try {
        readerEl.innerHTML = `<div class="${cls}">${msg}</div>`;
      } catch(e){ console.warn('showReaderMsg failed', e); }
    }

    try {
      const cams = await Html5Qrcode.getCameras().catch(e => { console.warn('getCameras failed', e); return []; });
      console.log('Cameras list:', cams);

      if (!cams || !cams.length) {
        // Fallback: intenta iniciar por facingMode (env)
        showReaderMsg('No se detectaron cámaras por ID; intentando cámara trasera...', 'small-muted');
        const qr = new Html5Qrcode("reader");
        try {
          await qr.start({ facingMode: { exact: "environment" } }, { fps: 10, qrbox: { width: 300, height: 300 } },
            txt => processScanned(txt),
            err => { /* opcional: console.warn(err) */ }
          );
          console.log('Scanner started with facingMode environment');
          return;
        } catch (errFacing) {
          // Probemos sin "exact" (más tolerante)
          try {
            await qr.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 300, height: 300 } },
              txt => processScanned(txt),
              err => {}
            );
            console.log('Scanner started with facingMode (non-exact)');
            return;
          } catch (err2) {
            console.error('No se pudo iniciar la cámara con facingMode', errFacing, err2);
            showReaderMsg('No fue posible iniciar la cámara en este dispositivo.', 'small-muted');
            return;
          }
        }
      }

      // Si hay cámaras listadas, intenta arrancar con la mejor disponible
      const qr = new Html5Qrcode("reader");
      let started = false;
      for (let i = 0; i < cams.length && !started; i++) {
        const cam = cams[i];
        try {
          console.log('Intentando cámara', i, cam);
          await qr.start(cam.id, { fps: 10, qrbox: { width: 300, height: 300 } },
            txt => processScanned(txt),
            err => {}
          );
          started = true;
          console.log('Scanner started with camera id', cam.id);
          break;
        } catch (err) {
          console.warn('Fallo al iniciar cámara', cam.id, err);
          // intenta siguiente cámara
        }
      }

      if (!started) {
        // último recurso: facingMode
        try {
          await qr.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 300, height: 300 } },
            txt => processScanned(txt),
            err => {}
          );
          console.log('Scanner started with facingMode fallback');
        } catch (err) {
          console.error('No se pudo iniciar el scanner con ningún método', err);
          showReaderMsg('No fue posible iniciar la cámara. Revisa permisos o prueba otro navegador.', 'small-muted');
        }
      }

    } catch (err) {
      console.error('Error al iniciar scanner:', err);
      readerEl.innerHTML = "<div class='small-muted'>Error inicializando el escáner — revisa la consola.</div>";
    }
  })();

});
  // Inicialización del scanner (ya no duplicada)
  
</script>

</body>
</html>
