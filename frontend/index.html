<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bienvenido - Identifícate</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>

  <style>
    :root{
      --bg: #07101a;
      --card: #0b1724;
      --muted: #94abc0;
      --accent: #2f9cff;
      --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body {
      padding: 1.25rem;
      background: linear-gradient(180deg, #051016 0%, #07101a 100%);
      color: #e6eef8;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      min-height:100vh;
    }
    .card {
      background: linear-gradient(180deg, var(--card), #071421);
      border: 1px solid rgba(255,255,255,0.03);
      border-radius: 14px;
      box-shadow: 0 10px 40px rgba(2,6,23,0.6);
    }

    h4 { font-weight:700; }
    .small-muted { color: var(--muted); font-size: .95rem; }

    /* Reader box */
    #reader {
      width: 420px;
      max-width: 100%;
      height: 320px;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      background: var(--glass);
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* status */
    #status { font-weight:700; margin-top:1rem; border-radius:8px; }
    .led {
      width: 20px; height: 20px; border-radius: 50%;
      display:inline-block; margin-right: 10px; vertical-align: middle;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      background: #3b4853;
    }
    .led.green { background: #2ecc71; box-shadow: 0 0 20px rgba(46,204,113,0.35); }
    .led.red { background: #e74c3c; box-shadow: 0 0 20px rgba(231,76,60,0.35); }
    .led.off { background: #3b4853; box-shadow: none; }

    /* manual area removed — keep layout tidy */
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }

    .busy { opacity: 0.6; pointer-events: none; }

    /* responsive */
    @media (max-width:720px) {
      #reader { height: 260px; }
      .controls { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card p-4 mt-4">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h4>Bienvenido — Identifícate</h4>
          <div class="small-muted">Escanea el código QR o usa el botón de historial para revisar registros.</div>
        </div>
        <div class="text-end">
          <!-- historial permanece intacto -->
          <a id="openHistoryBtn" href="history.html" class="btn btn-outline-light">Ver historial</a>
        </div>
      </div>

      <div id="reader" class="mb-3">
        <div class="small-muted">Cámara inactiva — espera...</div>
      </div>

      <div id="status" class="alert alert-secondary">Esperando escaneo...</div>

      <div class="d-flex align-items-center my-2 controls">
        <span id="led" class="led off" title="Estado del acceso"></span>
        <div style="flex:1">
          <div id="statusText" style="font-weight:600">Estado: esperando</div>
          <div id="subText" class="small-muted">sin actividad</div>
        </div>
        <!-- dejamos el botón de historial también aquí para accesibilidad -->
      </div>

      <!-- explicación breve -->
      <hr style="border-color: rgba(255,255,255,0.03)" />
      <div class="small-muted">Notas: Si el servidor corre en otra máquina, actualiza <code>BACKEND_URL</code> en el script.</div>
    </div>
  </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  console.log("DOM cargado — index.js init");

  // === CONFIG ===
  const BACKEND_URL = "http://localhost:3000"; // ajusta si corresponde
  const SCAN_DEBOUNCE_MS = 1200;
  let lastScan = 0;
  let processing = false;

  // DOM refs
  const statusEl = document.getElementById('status');
  const statusText = document.getElementById('statusText');
  const subText = document.getElementById('subText');
  const ledEl = document.getElementById('led');
  const readerEl = document.getElementById('reader');

  // UI helpers
  function setStatus(kind, main, sub='') {
    statusEl.className = 'alert';
    switch(kind) {
      case 'success': statusEl.classList.add('alert-success'); break;
      case 'error':   statusEl.classList.add('alert-danger');  break;
      case 'warning': statusEl.classList.add('alert-warning'); break;
      default:        statusEl.classList.add('alert-secondary');
    }
    statusEl.innerText = main;
    statusText.innerText = 'Estado: ' + main;
    subText.innerText = sub;
  }

  function setLed(color) {
    ledEl.classList.remove('green','red','off');
    if (color === 'green') ledEl.classList.add('green');
    else if (color === 'red') ledEl.classList.add('red');
    else ledEl.classList.add('off');
  }

  // parse QR payload (acepta JSON con id+token o simple token)
  function parseQrPayload(decodedText) {
    try {
      const obj = JSON.parse(decodedText);
      if (obj && obj.id && obj.token) return { id: String(obj.id), token: String(obj.token) };
    } catch { /* no es JSON */ }
    return { token: decodedText };
  }

  // enviar a backend - usamos /verify para comportamiento actual
  async function sendToBackend(payload) {
    if (!payload || !payload.token) return { authorized:false, message:'Token vacío' };
    try {
      const resp = await fetch(`${BACKEND_URL}/verify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: payload.id, token: payload.token }),
        cache: 'no-store'
      });
      return await resp.json();
    } catch (err) {
      console.error("Error conectando con backend:", err);
      return { authorized:false, message:'Error de conexión con backend' };
    }
  }

  // Core: procesar lectura QR
  async function processScanned(decodedText) {
    console.log("processScanned:", decodedText);
    const now = Date.now();
    if (processing || now - lastScan < SCAN_DEBOUNCE_MS) return;
    lastScan = now;
    processing = true;
    document.body.classList.add('busy');

    setStatus('warning','Validando token...','Conectando al servidor');
    const payload = parseQrPayload(decodedText);
    const result = await sendToBackend(payload);

    if (result && (result.authorized === true || result.authorized === 'true')) {
      setStatus('success','✔ Acceso autorizado', result.message || 'Autorizado');
      setLed('green');
    } else {
      // algunos endpoints devuelven { ok:true } u otros { authorized:true } — se manejan ambos arriba
      setStatus('error','✖ Acceso denegado', result.message || (result.error || 'Token incorrecto'));
      setLed('red');
    }

    processing = false;
    document.body.classList.remove('busy');
  }

  // Inicializar scanner (si hay cámara)
  if (window.Html5Qrcode) {
    Html5Qrcode.getCameras().then(cameras => {
      const camId = cameras.length ? cameras[0].id : null;
      if (camId) {
        // eliminamos contenido previo dentro de #reader por seguridad
        readerEl.innerHTML = '';
        const qr = new Html5Qrcode("reader");
        qr.start(camId, { fps: 10, qrbox: { width: 300, height: 300 } },
          decodedText => processScanned(decodedText),
          errorMessage => { /* ignore per-frame errors */ }
        ).catch(err => {
          console.error("No se pudo iniciar Html5Qrcode:", err);
          readerEl.innerHTML = '<div class="small-muted">No se pudo iniciar la cámara.</div>';
        });
      } else {
        console.warn("Cámara no detectada");
        readerEl.innerHTML = '<div class="small-muted">Cámara no detectada — utiliza un dispositivo con cámara.</div>';
      }
    }).catch(err => {
      console.error("Error al obtener cámaras:", err);
      readerEl.innerHTML = '<div class="small-muted">Error accediendo a la cámara.</div>';
    });
  } else {
    console.warn("Html5Qrcode no cargado.");
    readerEl.innerHTML = '<div class="small-muted">Escáner no disponible.</div>';
  }

  // auto-reset visual cada cierto tiempo para volver a 'esperando'
  setInterval(() => {
    setLed('off');
    setStatus('info','Esperando escaneo...','');
  }, 7000);
});
</script>

</body>
</html>
