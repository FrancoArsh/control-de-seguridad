<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Guard â€” Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --muted:#9fb0c8;
    }
    body{
      background:var(--bg);
      color:#e6eef8;
      padding:1rem;
      font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    }
    .card{ background:var(--card); border-radius:12px; }
    .muted{ color:var(--muted); }
    .muted-note{ color:#6f8aa3; font-size:.9rem; }
    .status-badge{
      padding:.35rem .6rem; border-radius:999px; font-weight:600;
    }
    .on{
      background:rgba(46,204,113,0.12);
      color:#2ecc71;
      border:1px solid rgba(46,204,113,0.18);
    }
    .off{
      background:rgba(231,76,60,0.08);
      color:#e74c3c;
      border:1px solid rgba(231,76,60,0.12);
    }
    .btn-ghost{
      background:transparent;
      border:1px solid rgba(255,255,255,0.08);
      color:#cbd5e1;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Guard â€” Panel</h4>
    <button id="btnLogout" class="btn btn-sm btn-outline-light">Cerrar sesiÃ³n</button>
  </div>

  <div id="alertArea"></div>

  <div class="row g-3">

    <!-- Columna izquierda -->
    <div class="col-lg-6">

      <!-- Control de turno -->
      <div class="card p-3">
        <div class="d-flex justify-content-between">
          <div>
            <h5 class="m-0">Control de Turno</h5>
            <div id="guardInfo" class="muted small mt-1">Guard: â€”</div>

            <div class="mt-2 d-flex gap-2 align-items-center">
              <div id="shiftBadge" class="status-badge off small">Fuera de turno</div>
              <div id="shiftTimes" class="muted-note small"></div>
            </div>
          </div>

          <div class="text-end">
            <button id="btnStartShift" class="btn btn-success mb-2">Iniciar turno</button>
            <button id="btnEndShift" class="btn btn-danger mb-2">Finalizar turno</button>
            <div class="muted small">Estado del guardia</div>
          </div>
        </div>
      </div>

      <!-- Acciones rÃ¡pidas -->
      <div class="card p-3 mt-3">
        <h5 class="m-0">Acciones rÃ¡pidas (manual)</h5>
        <p class="muted-note small mt-1">Usa esto si un estudiante no puede pasar con QR.</p>

        <div class="row g-2 mt-2">

          <div class="col-md-4">
            <input id="manualStudentId" class="form-control" placeholder="studentId">
          </div>

          <div class="col-md-4">
            <input id="manualToken" class="form-control" placeholder="token (opcional)">
          </div>

          <div class="col-md-4">
            <input id="manualNote" class="form-control" placeholder="Nota (opcional)">
          </div>

          <div class="col-12">
            <button id="btnManualAuthorize" class="btn btn-primary mt-2">
              Autorizar manual
            </button>
          </div>

          <div class="col-12 mt-3" id="manualRes"></div>
        </div>
      </div>

    </div>

    <!-- Columna derecha -->
    <div class="col-lg-6">
      <div class="card p-3">
        <h5 class="m-0">Resumen</h5>

        <h6 class="small mt-3">Ãšltima acciÃ³n</h6>
        <div id="lastAction" class="muted-note small">â€”</div>

        <button id="btnRefreshStatus" class="btn btn-ghost btn-sm mt-3">Actualizar estado</button>

        <hr class="my-3">

        <div class="muted-note">

      </div>
    </div>

  </div>
</div>

<script>
  const BACKEND_URL = "http://localhost:3000";
  const LOGIN_KEY = "guard_auth_token";
  const LOGIN_GUARD_ID = "guard_auth_guardid";

  /* ------------ helpers UI ----------- */
  function toast(msg, level='info'){
    const box = document.getElementById('alertArea');
    const el = document.createElement('div');
    el.innerHTML = `<div class="alert alert-${level} p-2">${msg}</div>`;
    box.appendChild(el);
    setTimeout(()=> el.remove(), 4000);
  }

  function showManualResult(msg, ok=true){
    document.getElementById('manualRes').innerHTML =
      `<div class="alert alert-${ok?'success':'danger'} p-2">${msg}</div>`;
  }

  const token = () => localStorage.getItem(LOGIN_KEY) || "";
  const guardId = () => localStorage.getItem(LOGIN_GUARD_ID) || "";

  function authHeaders(){
    const h = { "Content-Type": "application/json" };
    if (token()) h["Authorization"] = "Bearer " + token();
    return h;
  }

  /* ------------ UI enable/disable segÃºn turno ----------- */
  function updateUIForShift(isOnShift){
    const btn = document.getElementById('btnManualAuthorize');
    const sid = document.getElementById('manualStudentId');
    const tkn = document.getElementById('manualToken');
    const note = document.getElementById('manualNote');

    if(isOnShift){
      btn.disabled = false;
      sid.disabled = false;
      tkn.disabled = false;
      note.disabled = false;
      btn.title = "";
    }else{
      btn.disabled = true;
      sid.disabled = true;
      tkn.disabled = true;
      note.disabled = true;
      btn.title = "No puedes autorizar: no estÃ¡s en turno";
    }
  }

  /* ------------ cargar estado del turno ----------- */
  async function loadGuardInfoAndStatus(){
    const gid = guardId();
    document.getElementById("guardInfo").textContent = `Guard: ${gid || 'â€”'}`;

    if (!gid){
      document.getElementById('shiftBadge').className = "status-badge off small";
      document.getElementById('shiftBadge').textContent = "Fuera de turno";
      document.getElementById('shiftTimes').textContent = "";
      window.__currentShift = null;
      updateUIForShift(false);
      return;
    }

    try{
      const res = await fetch(`${BACKEND_URL}/guardShifts?guardId=${gid}&active=true`);
      const js = await res.json();

      if(js.data && js.data.length){
        const s = js.data[0];
        document.getElementById('shiftBadge').className = "status-badge on small";
        document.getElementById('shiftBadge').textContent = "En turno";

        document.getElementById('shiftTimes').textContent =
          "Inicio: " + new Date(s.startTimestamp).toLocaleString();
        window.__currentShift = s;
        updateUIForShift(true);
      }else{
        document.getElementById('shiftBadge').className = "status-badge off small";
        document.getElementById('shiftBadge').textContent = "Fuera de turno";
        document.getElementById('shiftTimes').textContent = "";
        window.__currentShift = null;
        updateUIForShift(false);
      }

    }catch(e){
      console.error(e);
      toast("Error obteniendo estado","danger");
      // Por seguridad, desactivar autorizaciones si hay error.
      window.__currentShift = null;
      updateUIForShift(false);
    }
  }

  /* ------------ cargar y mostrar Ãºltima acciÃ³n (para summary) ----------- */
  async function loadLastAction(){
    const gid = guardId();
    const el = document.getElementById('lastAction');
    el.textContent = "Cargando...";

    if (!gid) {
      el.innerHTML = `<span class="muted-note small">â€” (sin sesiÃ³n de guard)</span>`;
      return;
    }

    try {
      // Pedimos guardAuthorizations filtrando por guardId
      const res = await fetch(`${BACKEND_URL}/guardAuthorizations?guardId=${encodeURIComponent(gid)}`, {
        headers: authHeaders()
      });
      const js = await res.json();
      if (!res.ok) {
        console.warn("loadLastAction backend error:", js);
        el.innerHTML = `<span class="muted-note small">No se pudo obtener Ãºltima acciÃ³n</span>`;
        return;
      }

      const arr = js.data || [];
      if (!arr.length) {
        el.innerHTML = `<span class="muted-note small">â€” (sin acciones registradas)</span>`;
        return;
      }

      // Ordenar por timestamp descendente y tomar la mÃ¡s reciente
      arr.sort((a,b) => (b.timestamp||0) - (a.timestamp||0));
      const last = arr[0];

      // Construir representaciÃ³n legible
      const when = last.timestamp ? new Date(last.timestamp).toLocaleString() : "â€”";
      const who = last.studentId ? last.studentId : (last.token ? `token: ${last.token}` : "â€”");
      const note = last.note ? String(last.note) : "";
      const reason = last.reason ? String(last.reason) : "";

      // Intentar obtener nombre de student si existe (consulta ligera)
      let studentNameHtml = "";
      if (last.studentId) {
        try {
          const ures = await fetch(`${BACKEND_URL}/user/${encodeURIComponent(last.studentId)}`);
          if (ures.ok) {
            const ujs = await ures.json();
            if (ujs.ok && ujs.name) studentNameHtml = ` â€” ${ujs.name}`;
          }
        } catch (_) { /* no crÃ­tico */ }
      }

      el.innerHTML = `
        <div class="small">
          <strong>${who}</strong>${studentNameHtml}<br>
          <span class="muted-note">Motivo: ${reason}${note ? ` Â· Nota: ${note}` : ""} Â· ${when}</span>
        </div>
      `;
    } catch (err) {
      console.error("loadLastAction error:", err);
      el.innerHTML = `<span class="muted-note small">Error cargando Ãºltima acciÃ³n</span>`;
    }
  }

async function showGuardPin(guardId) {
    if (!guardId) {
        alert("Error: ID del guardia no disponible.");
        return;
    }

    try {
        // Llamada a la nueva ruta GET del backend
        const response = await fetch(`${BACKEND_URL}/api/guards/${guardId}/pin`);
        
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({error: 'Error de red o servidor.'}));
            throw new Error(errorData.error || 'No se pudo obtener el PIN.');
        }

        const data = await response.json();
        const pin = data.pin;

        // Mostrar el PIN
        alert(`ðŸ”‘ PIN del Guardia ID ${guardId}:\n\n${pin}`);

    } catch (error) {
        console.error('Error al mostrar PIN:', error);
        alert(`Error al obtener PIN: ${error.message}`);
    }
}

  /* ------------ iniciar turno ----------- */
  async function startShift(){
    try{
      const res = await fetch(`${BACKEND_URL}/guard/shift/start`,{
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify({})
      });
      const js = await res.json();
      if(!res.ok) return toast(js.error,"danger");

      toast("Turno iniciado","success");
      // actualizar estado y resumen
      await loadGuardInfoAndStatus();
      await loadLastAction();
    }catch(e){
      toast("Error de red","danger");
    }
  }

  /* ------------ finalizar turno ----------- */
  async function endShift(){
    try{
      const res = await fetch(`${BACKEND_URL}/guard/shift/end`,{
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify({})
      });
      const js = await res.json();
      if(!res.ok) return toast(js.error,"danger");

      toast("Turno finalizado","success");
      // actualizar estado y resumen
      await loadGuardInfoAndStatus();
      await loadLastAction();
    }catch(e){
      toast("Error de red","danger");
    }
  }

  /* ------------ autorizaciÃ³n manual ----------- */
  async function manualAuthorize(){
    // ValidaciÃ³n frontal: no permitir autorizar si no hay turno activo.
    if(!window.__currentShift){
      return showManualResult("No puedes autorizar: estÃ¡s fuera de turno.", false);
    }

    const sid = manualStudentId.value.trim();
    const tkn = manualToken.value.trim();
    const note = manualNote.value.trim();

    if(!sid && !tkn) return showManualResult("Debes ingresar studentId o token",false);

    const body = {
      studentId: sid || undefined,
      token: tkn || undefined,
      note: note || undefined,
      shiftId: window.__currentShift ? window.__currentShift.id : undefined
    };

    try{
      const res = await fetch(`${BACKEND_URL}/guard/authorize`,{
        method:"POST",
        headers: authHeaders(),
        body: JSON.stringify(body)
      });
      const js = await res.json();

      if(!res.ok) return showManualResult(js.error,false);

      showManualResult("Acceso concedido",true);
      manualStudentId.value = "";
      manualToken.value = "";
      manualNote.value = "";

      // refrescar resumen y estado
      await loadLastAction();
    }catch(e){
      showManualResult("Error de red",false);
    }
  }

  /* ------------ logout ----------- */
  function logout(){
    if(!confirm("Â¿Cerrar sesiÃ³n?")) return;
    localStorage.removeItem(LOGIN_KEY);
    localStorage.removeItem(LOGIN_GUARD_ID);
    window.location.href = "guard-login.html";
  }

  /* ------------ eventos ----------- */
  btnStartShift.onclick = startShift;
  btnEndShift.onclick = endShift;
  btnManualAuthorize.onclick = manualAuthorize;
  // ahora el botÃ³n refresca estado y resumen
  btnRefreshStatus.onclick = async () => { await loadGuardInfoAndStatus(); await loadLastAction(); };
  btnLogout.onclick = logout;

  // carga inicial
  (async () => {
    await loadGuardInfoAndStatus();
    await loadLastAction();
  })();
</script>

</body>
</html>

