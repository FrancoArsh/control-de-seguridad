<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Historial de Accesos — Control de Seguridad</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0b1220; color:#e6eef8; padding:1.25rem; }
    .card { border-radius:10px; }
    .muted { color:#9fb0c8; }
    .badge-ok { background:#28a745; color:#fff; padding:.35rem .6rem; border-radius:.35rem; display:inline-block; }
    .badge-fail { background:#dc3545; color:#fff; padding:.35rem .6rem; border-radius:.35rem; display:inline-block; }
    table td, table th { vertical-align: middle; }
    .mono { font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>Historial de Accesos</h3>
      <div>
        <a href="index.html" class="btn btn-sm btn-outline-light">Volver al Totem</a>
      </div>
    </div>

    <div class="card p-3 mb-3">
      <div class="row g-2">
        <div class="col-md-4">
          <label class="form-label small muted">Buscar por Guardia (nombre o ID)</label>
          <input id="filterGuard" class="form-control" placeholder="Ej: Carlos o guard-01">
        </div>

        <div class="col-md-4">
          <label class="form-label small muted">Filtrar por shiftId</label>
          <input id="filterShift" class="form-control" placeholder="ID de turno (shiftId)">
        </div>

        <div class="col-md-4">
          <label class="form-label small muted">Resultado</label>
          <select id="filterResult" class="form-select">
            <option value="">Todos</option>
            <option value="ok">Autorizado</option>
            <option value="denied">Denegado</option>
          </select>
        </div>
      </div>
    </div>

    <div class="card p-3">
      <div class="table-responsive">
        <table class="table table-sm text-white table-borderless mb-0">
          <thead class="muted small">
            <tr>
              <th style="width:160px">Fecha / Hora</th>
              <th style="width:110px">ID Estudiante</th>
              <th>Nombre</th>
              <th style="width:130px">Token</th>
              <th style="width:120px">Resultado</th>
              <th>Motivo</th>
              <th style="width:180px">Guardia (nombre · id)</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="7" class="muted">Cargando datos…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="muted small mt-2">Auto-refresh cada 3 segundos. Si tu backend está en otra URL, actualiza <code>BACKEND_URL</code> en el script.</div>
  </div>

<script>
  // Ajusta esta URL si tu backend no está en localhost:3000
  const BACKEND_URL = "https://control-de-seguridad.onrender.com";

  function msToLocal(ts) {
    try {
      const n = Number(ts);
      if (!n) return "";
      return new Date(n).toLocaleString("es-CL");
    } catch {
      return "";
    }
  }

  function shortToken(t) {
    if (!t) return "";
    return t.length > 10 ? t.slice(0,4) + "…" + t.slice(-4) : t;
  }

  function renderRow(entry) {
    const fecha = msToLocal(entry.timestamp || entry.time || 0);
    const id = entry.studentUid || entry.id || "-";
    const name = entry.studentName || entry.name || "-";
    const token = shortToken(entry.token || "");
    const motivo = entry.note || entry.reason || "-";

    const guardDisplay = (entry.guardName && entry.guardId)
      ? `${entry.guardName} · ${entry.guardId}`
      : (entry.guardName || entry.guardId || "-");

    const resultadoHtml = (entry.authorized === true)
      ? '<span class="badge-ok">Autorizado</span>'
      : (entry.authorized === false ? '<span class="badge-fail">Rechazado</span>' : '<span class="muted">Desconocido</span>');

    return [
      "<tr>",
        "<td>" + fecha + "</td>",
        "<td class='mono'>" + id + "</td>",
        "<td>" + escapeHtml(name) + "</td>",
        "<td class='mono'>" + escapeHtml(token) + "</td>",
        "<td>" + resultadoHtml + "</td>",
        "<td>" + escapeHtml(motivo) + "</td>",
        "<td>" + escapeHtml(guardDisplay) + "</td>",
      "</tr>"
    ].join("");
  }

  // pequeña función de escape para seguridad visual
  function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
  }

  async function fetchHistory(limit = 500) {
    try {
      const res = await fetch(BACKEND_URL + "/history?limit=" + encodeURIComponent(limit));
      if (!res.ok) {
        console.error("/history returned status", res.status);
        return [];
      }
      const js = await res.json();
      return js.data || [];
    } catch (e) {
      console.error("fetchHistory error:", e);
      return [];
    }
  }

  async function loadAndRender() {
    const fGuard = document.getElementById("filterGuard").value.trim().toLowerCase();
    const fShift = document.getElementById("filterShift").value.trim().toLowerCase();
    const fResult = document.getElementById("filterResult").value;

    const rows = await fetchHistory(500);
    let filtered = rows.slice();

    if (fGuard) {
      filtered = filtered.filter(r => {
        const combined = ((r.guardName || "") + " " + (r.guardId || "")).toLowerCase();
        return combined.includes(fGuard);
      });
    }

    if (fShift) {
      filtered = filtered.filter(r => (r.shiftId || "").toLowerCase().includes(fShift));
    }

    if (fResult === "ok") filtered = filtered.filter(r => r.authorized === true);
    if (fResult === "denied") filtered = filtered.filter(r => r.authorized === false);

    filtered.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));

    const tbody = document.getElementById("historyBody");
    if (!filtered.length) {
      tbody.innerHTML = "<tr><td colspan='7' class='muted'>Sin registros</td></tr>";
      return;
    }

    tbody.innerHTML = filtered.map(renderRow).join("");
  }

  // Listeners de filtros
  document.getElementById("filterGuard").addEventListener("input", loadAndRender);
  document.getElementById("filterShift").addEventListener("input", loadAndRender);
  document.getElementById("filterResult").addEventListener("change", loadAndRender);

  // Auto-refresh cada 3 segundos
  let autoRefreshId = null;
  function startAutoRefresh() {
    if (autoRefreshId) clearInterval(autoRefreshId);
    autoRefreshId = setInterval(() => {
      loadAndRender().catch(e => console.error("auto-refresh error:", e));
    }, 3000);
  }

  window.addEventListener("load", () => {
    loadAndRender().catch(e => console.error(e));
    startAutoRefresh();
  });

  window.addEventListener("beforeunload", () => {
    if (autoRefreshId) clearInterval(autoRefreshId);
  });
</script>
</body>
</html>
